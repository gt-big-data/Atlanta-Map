<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>MARTA Bus Optimization</title>
    <link rel="shortcut icon" href="marta-square.png">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css-dist/styles.min.css" />
    <script src='https://d3js.org/d3.v4.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous" defer></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.bundle.min.js" integrity="sha384-lZmvU/TzxoIQIOD9yQDEpvxp6wEU32Fy0ckUgOH4EIlMOCdR823rg4+3gWRwnX1M" crossorigin="anonymous" defer></script>
    <script src="js/main.min.js" defer></script>

    <link rel="stylesheet" type="text/css" href="day.css" id="time-stylesheet">
  </head>
  <body>
    <img src="marta.png" alt="MARTA Logo" height="100" width="300">
    <nav id="headerMarta" class="navbar navbar-expand-sm navbar-light bg-light">
      <a class="navbar-brand" href="#"><img id="navLogo" src="marta.png" alt="MARTA Logo" height="33" width="100"></a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="#">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Bus Routes
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a class="dropdown-item" href="#">Bus 1</a>
              <a class="dropdown-item" href="#">Bus 2</a>
              <!--  CAN ADD MORE BUS ROUTES HERE  -->
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Colors
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a class="dropdown-item" href="#" id="day" onclick="changeDay()">Light Mode</a>
              <a class="dropdown-item" href="#" id="night" onclick="changeNight()">Dark Mode</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <div id="map"></div>
    <script>
      function initMap() {
        var georgiaTech = {lat: 33.7756, lng: -84.3963};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: georgiaTech
        });

        var transitLayer = new google.maps.TransitLayer();
        transitLayer.setMap(map);
        var curr_markers = {};
        var infowindow = new google.maps.InfoWindow();
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var buses = JSON.parse(this.responseText);
            var new_markers = {};
            for (var i = 0; i < buses.length; i++) {

            	var busID = parseInt(buses[i].vehicle);

            	if (busID in curr_markers) {
            		new_markers[busID] = curr_markers[busID];
            		new_markers[busID].setPosition(new google.maps.LatLng(buses[i].latitude, buses[i].longitude));
            		delete curr_markers[busID];
            	} else {
	            	var marker = new google.maps.Marker({
	          			position: {lat: parseFloat(buses[i].latitude), lng: parseFloat(buses[i].longitude)},
	          			map: map,
                  icon: "assets/BusIcon.svg"
                });
                var latitude = parseFloat(buses[i].latitude);
                var longitude = parseFloat(buses[i].longitude);
                var message = '<div><strong>' + buses[i].timepoint
                  + '</strong><br>@ ' + buses[i].msg_time + '<br>Route '
                  + buses[i].route + '<br>' + '(' + latitude + ' , ' + longitude
                  + ')' + '</div>';
                console.log(buses[i]);
                attachInfo(marker, message);
            		new_markers[busID] = marker;
            	}
              delete curr_markers[busID];
            }
            var remove_list = Object.keys(curr_markers);
            for (var i = 0; i < remove_list.length; i++) {
	          	curr_markers[remove_list[i]].setMap(null);
	          	delete curr_markers[remove_list[i]];
            }
            curr_markers = new_markers;
          }
        };
        xhttp.open("GET", "http://localhost:5000/get_buses", true);
        xhttp.send();

        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var incidents = JSON.parse(this.responseText);
                var arr = JSON.parse(this.responseText);
                var list = [];
                for (var i = 0; i < arr.length; i++) {
                    if (arr[i].shape_pt_sequence == 1) {
                        var flightPath = new google.maps.Polyline({
                            path: list,
                            geodesic: true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2
                        });
                        flightPath.setMap(map);
                        list = [];
                    } else {
                    list.push({lat: arr[i].shape_pt_lat, lng: arr[i].shape_pt_lon});
                    }
            }
          }
        };
        xhttp2.open("GET", "routes.json", true);
        xhttp2.send();
        var ajax_call = function() {
  	      xhttp.open("GET", "http://localhost:5000/get_buses", true);
          xhttp.send();
        };
        var attachInfo = function(marker, info) {
          google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent(info);
            infowindow.open(map, marker);
          });
        };

        var getDistance = function(start_long, start_lat, end_long, end_lat) {
            // Option 1
            url = 'https://maps.googleapis.com/maps/api/distancematrix/json?';
            url += 'origins=' + start_long + ',' + start_lat + '&destinations='
                + end_long + ',' + end_lat + '&key=' + key;
            r = requests.get(url);
            js = r.json();

            //Option 2
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: start,
                destinations: end,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.IMPERIAL
            }, callback);
            // Call Back not implemented yet
        }
        getDistance(40, 70, 90, 100);

        var interval = 1000 * 60 * 1; // where X is your every X minutes
        setInterval(ajax_call, interval);
      };
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=[]&callback=initMap">
  </script>
    </body>
  </html>
